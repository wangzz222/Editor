# OLMD开发文档

## 目录

- [项目概述](#项目概述)
- [技术架构](#技术架构)
  - [后端技术栈](#后端技术栈)
  - [前端技术栈](#前端技术栈)
  - [流程图展示](#流程图展示)

- [核心功能实现](#核心功能实现)
  - [编辑器实现](#编辑器实现)
  - [实时协作功能](#实时协作功能)
  - [Markdown渲染](#markdown渲染)
  - [权限管理系统](#权限管理系统)
  - [身份认证](#身份认证)
  - [图片上传](#图片上传)
  - [导出与分享](#导出与分享)
- [项目结构说明](#项目结构说明)
- [数据模型](#数据模型)
- [API接口](#api接口)
- [配置项](#配置项)
- [开发环境搭建](#开发环境搭建)

## 项目概述

OLMD是一个实时协作Markdown编辑器，基于HackMD的源代码开发，允许用户在多平台环境下进行文档协作。提供丰富的Markdown语法支持、实时预览、版本历史、多种认证方式以及权限控制等功能。**目前没有实现离线功能。**

### 主要特点

- 实时协作编辑：多用户可同时编辑同一文档，实时显示其他用户的编辑内容
- Markdown支持：支持标准Markdown和额外扩展语法
- 多视图模式：编辑模式、预览模式、双栏模式
- 幻灯片模式：将文档转为幻灯片展示
- ~~多种身份验证：支持OAuth、LDAP、SAML等多种身份验证方式~~
- 权限控制系统：灵活的文档访问和编辑权限管理
- 图片上传：支持多种图片存储方式
- 导出功能：支持多种格式导出
- 主题切换：支持日间/夜间模式

## 技术架构

### 后端技术栈

- **运行环境**：Node.js (>=14.0.0 <17.0.0)
- **Web框架**：Express
- **数据库**：
  - ~~PostgreSQL（推荐用于生产环境）~~
  - ~~MySQL~~
  - SQLite（适用于开发环境）
- **ORM工具**：Sequelize
- **实时通信**：Socket.IO
- **身份验证**：Passport
- **模板引擎**：EJS
- **打包工具**：Webpack

### 前端技术栈

- **编辑器核心**：CodeMirror
- **JavaScript库**：jQuery
- **UI框架**：Bootstrap 3
- **Markdown解析器**：markdown-it
- **实时通信客户端**：Socket.IO Client
- **同步协作**：Operational Transformation (OT)

### 流程图展示
#### 1.  用户编辑流程

<img src="E:\GoogleDownload\Editor _ Mermaid Chart-2025-05-09-070116.png" alt="Editor _ Mermaid Chart-2025-05-09-070116" style="zoom: 20%;" />

#### 2. 实时协作流程

<img src="F:\Editor\codimd\assets\Editor _ Mermaid Chart-2025-05-09-070326.png" alt="Editor _ Mermaid Chart-2025-05-09-070326" style="zoom: 23%;" />

#### 3. 系统架构流程

<img src="F:\Editor\codimd\assets\Editor _ Mermaid Chart-2025-05-09-070524.png" alt="Editor _ Mermaid Chart-2025-05-09-070524" style="zoom: 23%;" />



#### 4. 版本历史处理流程

![Editor _ Mermaid Chart-2025-05-09-065921](F:\Editor\codimd\assets\Editor _ Mermaid Chart-2025-05-09-065921.png)
#### 5. 权限控制流程

<img src="F:\Editor\codimd\assets\Editor _ Mermaid Chart-2025-05-09-065654.png" alt="Editor _ Mermaid Chart-2025-05-09-065654" style="zoom: 20%;" />

#### 6. 用户认证流程

<img src="F:\Editor\codimd\assets\Editor _ Mermaid Chart-2025-05-09-065833.png" alt="Editor _ Mermaid Chart-2025-05-09-065833" style="zoom: 20%;" />

## 核心功能实现

### 编辑器实现

OLMD的编辑器基于CodeMirror，并进行了大量自定义扩展来支持Markdown编辑和实时协作。

#### 编辑器初始化

编辑器的初始化主要在`public/js/lib/editor/index.js`中实现：

```javascript
export default class Editor {
  constructor () {
    this.editor = null
    this.jumpToAddressBarKeymapValue = null
    // ...
  }
  
  // 初始化编辑器
  init(textAreaId) {
    // 创建CodeMirror实例
    this.editor = CodeMirror.fromTextArea(
      document.getElementById(textAreaId), {
        mode: defaultEditorMode,
        // ...其他配置
      }
    )
    
    // 设置键盘映射和事件处理
    this.editor.on('change', this.onChange.bind(this))
    // ...
  }
  
  // 其他编辑器方法
}
```

#### 定义快捷键

编辑器支持丰富的快捷键操作，如加粗、斜体、链接等Markdown格式化操作：

```javascript
this.defaultKeyMap = {
  'Ctrl-*': cm => {
    utils.wrapTextWith(this.editor, cm, '*')
  },
  'Shift-Ctrl-8': cm => {
    utils.wrapTextWith(this.editor, cm, '*')
  },
  'Ctrl-_': cm => {
    utils.wrapTextWith(this.editor, cm, '_')
  },
  // ...更多快捷键映射
}
```

#### 表格编辑器

OLMD实现了特殊的表格编辑功能，通过`table-editor.js`提供表格的创建、编辑、格式化等功能：

```javascript
class TextEditorInterface {
  constructor (editor) {
    this.editor = editor
    this.doc = editor.getDoc()
    this.transaction = false
    this.onDidFinishTransaction = null
  }
  
  // 表格操作方法
  setSelectionRange (range) {
    this.doc.setSelection(
      { line: range.start.row, ch: range.start.column },
      { line: range.end.row, ch: range.end.column }
    )
  }
  // ...
}
```

### 实时协作功能

OLMD的实时协作基于Operational Transformation算法和Socket.IO实现，允许多用户同时编辑同一文档。

#### 服务端实现

实时协作的服务端核心逻辑在`lib/realtime/realtime.js`中实现：

```javascript
// realtime
const realtime = {
  io: null,
  onAuthorizeSuccess: onAuthorizeSuccess,
  onAuthorizeFail: onAuthorizeFail,
  secure: secure,
  connection: connection,
  getStatus: getStatus,
  isReady: isReady,
  maintenance: true
}

// Socket连接处理
function connection (socket) {
  // 处理用户连接
  // 设置各种事件监听器
}

// 操作处理回调
function operationCallback (socket, operation) {
  // 处理编辑操作，广播给其他用户
}
```

#### Operational Transformation实现

系统使用OT算法确保多用户编辑时的一致性，相关实现在`lib/ot/`目录下：

```javascript
// 编辑器服务器实现
function EditorSocketIOServer(document, operations, docId, mayWrite, operationCallback) {
    EventEmitter.call(this);
    Server.call(this, document, operations);
    this.users = {};
    this.docId = docId;
    this.mayWrite = mayWrite || function (_, cb) {
        cb(true);
    };
    this.operationCallback = operationCallback;
}
```

#### 客户端实现

客户端同步逻辑在`public/js/index.js`中实现，通过Socket.IO与服务器通信：

```javascript
socket.on('doc', function (obj) {
  var body = obj.str
  var bodyMismatch = editor.getValue() !== body
  var setDoc = !cmClient || (cmClient && (cmClient.revision === -1 || (cmClient.revision !== obj.revision && !havePendingOperation()))) || obj.force

  // 保存编辑器状态
  saveInfo()
  if (setDoc && bodyMismatch) {
    // 更新编辑器内容
    if (cmClient) cmClient.editorAdapter.ignoreNextChange = true
    if (body) editor.setValue(body)
    else editor.setValue('')
  }

  // 初始化或更新协作客户端
  if (!cmClient) {
    cmClient = window.cmClient = new EditorClient(
      obj.revision, obj.clients,
      new SocketIOAdapter(socket), new CodeMirrorAdapter(editor)
    )
    // ...
  } else if (setDoc) {
    // 更新现有协作客户端
    // ...
  }
})
```

#### 用户光标同步

系统支持显示其他用户的光标位置：

```javascript
function buildCursor (user) {
  if (appState.currentMode === modeType.view) return
  if (!user.cursor) return
  
  // 计算光标位置
  var coord = editor.charCoords(user.cursor, 'windows')
  
  // 创建光标DOM元素
  const cursor = $('<div data-clientid="' + user.id + '" class="CodeMirror-other-cursor" style="display:none;"></div>')
  cursor.attr('data-line', user.cursor.line)
  cursor.attr('data-ch', user.cursor.ch)
  
  // 添加光标样式
  const cursorbar = $('<div class="cursorbar">&nbsp;</div>')
  cursorbar[0].style.borderLeft = '2px solid ' + user.color
  
  // 显示用户信息
  const cursortag = $('<div class="cursortag">' + icon + '&nbsp;<span class="name">' + user.name + '</span></div>')
  cursortag[0].style.color = user.color
  
  // ...
}
```

### Markdown渲染

OLMD使用markdown-it作为Markdown渲染引擎，并添加了多种扩展和自定义语法支持。

#### 渲染过程

Markdown渲染主要在`public/js/index.js`的`updateViewInner`函数中实现：

```javascript
function updateViewInner () {
  if (appState.currentMode === modeType.edit || !isDirty) return
  var value = editor.getValue()
  var lastMeta = md.meta
  md.meta = {}
  delete md.metaError
  
  // 渲染Markdown
  var rendered = md.render(value)
  
  // 处理特殊模式（如幻灯片）
  if (md.meta.type && md.meta.type === 'slide') {
    var slideOptions = {
      separator: '^(\r\n?|\n)---(\r\n?|\n)$',
      verticalSeparator: '^(\r\n?|\n)----(\r\n?|\n)$'
    }
    var slides = window.RevealMarkdown.slidify(editor.getValue(), slideOptions)
    ui.area.markdown.html(slides)
    window.RevealMarkdown.initialize()
    // ...
  } else {
    // 常规渲染处理
    // ...
    
    // 防止XSS攻击
    rendered = preventXSS(rendered)
    var result = postProcess(rendered).children().toArray()
    partialUpdate(result, lastResult, ui.area.markdown.children().toArray())
    
    // ...
  }
  
  // 后处理：添加事件监听器，生成目录等
  removeDOMEvents(ui.area.markdown)
  finishView(ui.area.markdown)
  autoLinkify(ui.area.markdown)
  deduplicatedHeaderId(ui.area.markdown)
  renderTOC(ui.area.markdown)
  generateToc('ui-toc')
  generateToc('ui-toc-affix')
}
```

#### 同步滚动实现

OLMD支持编辑视图和预览视图的同步滚动，通过给Markdown元素添加行数信息实现：

```javascript
// 在lib/js/lib/syncscroll.js中
md.renderer.rules.heading_open = function (tokens, idx, options, env, self) {
  tokens[idx].attrJoin('class', 'raw')
  addPart(tokens, idx)
  return self.renderToken(...arguments)
}

// addPart函数添加行号信息
function addPart(tokens, idx) {
  if (tokens[idx].map) {
    const startline = tokens[idx].map[0] + 1
    const endline = tokens[idx].map[1]
    tokens[idx].attrJoin('data-startline', startline)
    tokens[idx].attrJoin('data-endline', endline)
  }
}
```

### 权限管理系统

OLMD提供了细粒度的权限控制系统，允许控制笔记的访问和编辑权限。

#### 权限类型

权限类型定义在`lib/models/note.js`中：

```javascript
// 权限类型
var permissionTypes = ['freely', 'editable', 'limited', 'locked', 'protected', 'private']
```

每种权限的说明：
- **freely**：任何人都可以查看和编辑
- **editable**：任何人都可以查看，但只有登录用户可以编辑
- **limited**：只有登录用户可以查看和编辑
- **locked**：任何人都可以查看，只有笔记所有者可以编辑
- **protected**：只有登录用户可以查看，只有笔记所有者可以编辑
- **private**：只有笔记所有者可以查看和编辑

#### 权限检查

权限检查主要通过`newCheckViewPermission`函数实现：

```javascript
function newCheckViewPermission (note, isLogin, userId) {
  if (note.permission === 'private') {
    return note.ownerId === userId
  }
  if (note.permission === 'limited' || note.permission === 'protected') {
    return isLogin
  }
  return true
}
```

编辑权限检查：

```javascript
function canEditNote (notePermission, noteOwnerId, currentUserId) {
  if (!currentUserId) {
    return notePermission === 'freely'
  } else if (noteOwnerId === currentUserId) {
    return true
  } else if (notePermission === 'freely' || notePermission === 'editable' || notePermission === 'limited') {
    return true
  }
  return false
}
```

### 身份认证

- 本地Email/密码

### 图片上传

OLMD支持多种图片上传和存储方式。

#### 支持的存储方式

- 本地文件系统
- Imgur
- Amazon S3
- Minio
- Azure Storage
- Lutim

#### 图片上传实现

图片上传功能主要在`lib/imageRouter/`目录下实现，支持拖放、粘贴和上传按钮三种方式。

客户端图片上传处理：

```javascript
// 处理图片粘贴
function pasteHandler (e) {
  // ...
  const items = e.clipboardData.items
  for (let i = 0; i < items.length; i++) {
    if (items[i].kind === 'file') {
      const blob = items[i].getAsFile()
      // 处理图片文件
      uploadImage(blob)
    }
  }
}

// 上传图片到服务器
function uploadImage(file) {
  var formData = new FormData()
  formData.append('image', file)
  
  $.ajax({
    url: '/upload',
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function (data) {
      // 插入图片Markdown到编辑器
      insertImage(data.link)
    }
    // ...
  })
}
```

### 导出与分享

OLMD提供多种导出和分享功能。

#### 导出方式

- Markdown文件下载
- ~~PDF导出~~  

> 有问题

- 发布为公开链接
- 幻灯片模式

>  有问题

#### 导出实现

以PDF导出为例，在`lib/note/noteActions.js`中实现：

```javascript
function actionPDF (req, res, note) {
  var url = config.serverURL + '/s/' + note.shortid
  var title = Note.decodeTitle(note.title)
  
  // 生成PDF
  markdownpdf().from.url(url).to(path.join(config.tmpPath, Date.now() + '.pdf'), function (err, result) {
    if (err) {
      // 处理错误
    } else {
      // 返回PDF文件
      res.sendFile(result, {
        headers: {
          'Content-Type': 'application/pdf',
          'Content-Disposition': 'attachment; filename="' + title + '.pdf"'
        }
      })
    }
  })
}
```

## 项目结构说明

OLMD项目的主要目录结构如下：

```
/
├── app.js                # 应用入口点
├── lib/                  # 核心功能模块
│   ├── auth/             # 认证模块
│   ├── config/           # 配置处理
│   ├── models/           # 数据模型
│   ├── note/             # 笔记相关功能
│   ├── ot/               # 操作转换算法
│   ├── realtime/         # 实时协作功能
│   ├── imageRouter/      # 图片上传处理
│   └── routes.js         # 路由定义
├── public/               # 静态资源目录
│   ├── css/              # 样式文件
│   ├── js/               # 客户端JavaScript
│   │   ├── index.js      # 主JS文件
│   │   └── lib/          # 客户端库
│   │       ├── editor/   # 编辑器相关
│   │       └── ...       # 其他功能模块
│   └── views/            # 视图模板
├── locales/              # 国际化文件
├── bin/                  # 命令行工具
└── test/                 # 测试文件
```

### 关键文件说明

- **app.js**：应用程序入口点，配置Express服务器和Socket.IO
- **lib/models/**：数据模型定义，使用Sequelize ORM
- **lib/realtime/realtime.js**：实时协作核心逻辑
- **lib/ot/**：操作转换算法实现
- **public/js/index.js**：客户端主逻辑
- **public/js/lib/editor/**：编辑器相关实现
- **lib/routes.js**：HTTP路由定义

## 数据模型

OLMD使用Sequelize ORM与数据库交互，主要数据模型如下：

### Note模型

```javascript
var Note = sequelize.define('Note', {
  id: {
    type: DataTypes.UUID,
    primaryKey: true,
    defaultValue: Sequelize.UUIDV4
  },
  shortid: {
    type: DataTypes.STRING,
    unique: true,
    allowNull: false,
    defaultValue: shortId.generate
  },
  alias: {
    type: DataTypes.STRING,
    unique: true
  },
  permission: {
    type: DataTypes.ENUM,
    values: permissionTypes
  },
  viewcount: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 0
  },
  title: {
    type: DataTypes.TEXT
    // getter和setter处理
  },
  content: {
    type: DataTypes.TEXT('long')
    // getter和setter处理
  },
  authorship: {
    type: DataTypes.TEXT('long')
    // 存储协作信息
  },
  lastchangeAt: {
    type: DataTypes.DATE
  },
  savedAt: {
    type: DataTypes.DATE
  }
})
```

### User模型

```javascript
var User = sequelize.define('User', {
  id: {
    type: DataTypes.UUID,
    primaryKey: true,
    defaultValue: Sequelize.UUIDV4
  },
  profileid: {
    type: DataTypes.STRING,
    unique: true
  },
  profile: {
    type: DataTypes.TEXT
  },
  history: {
    type: DataTypes.TEXT
  },
  accessToken: {
    type: DataTypes.TEXT
  },
  refreshToken: {
    type: DataTypes.TEXT
  },
  email: {
    type: DataTypes.STRING
  },
  password: {
    type: DataTypes.STRING
  }
})
```

### Revision模型

```javascript
var Revision = sequelize.define('Revision', {
  id: {
    type: DataTypes.UUID,
    primaryKey: true,
    defaultValue: Sequelize.UUIDV4
  },
  content: {
    type: DataTypes.TEXT('long')
  },
  length: {
    type: DataTypes.INTEGER
  },
  authorship: {
    type: DataTypes.TEXT('long')
  }
})
```

### 模型关联

```javascript
Note.associate = function (models) {
  Note.belongsTo(models.User, {
    foreignKey: 'ownerId',
    as: 'owner'
  })
  Note.belongsTo(models.User, {
    foreignKey: 'lastchangeuserId',
    as: 'lastchangeuser'
  })
  Note.hasMany(models.Revision, {
    foreignKey: 'noteId'
  })
  Note.hasMany(models.Author, {
    foreignKey: 'noteId',
    as: 'authors'
  })
}
```

## API接口

OLMD提供多种API接口用于笔记操作：

### 笔记操作API

```
GET  /:noteId         - 显示笔记
POST /new             - 创建新笔记
GET  /s/:shortid      - 显示发布的笔记
PUT  /api/notes/:noteId - 更新笔记内容
DELETE /api/notes/:noteId - 删除笔记
GET  /api/notes/myNotes - 获取用户笔记列表
```

### 历史记录API

```
GET  /history         - 获取历史记录
POST /history         - 更新历史记录
DELETE /history       - 清除历史记录
```

### 用户API

```
GET  /me              - 获取当前用户信息
GET  /me/delete/:token - 删除当前用户
POST /me/export       - 导出用户数据
```

## 配置项

OLMD提供大量配置选项，可通过环境变量或配置文件设置：

### 核心配置

```javascript
// 服务器配置
domain: '',             // 域名
urlPath: '',            // URL路径
host: '0.0.0.0',        // 监听地址
port: 3000,             // 监听端口
useSSL: false,          // 是否使用SSL

// 权限配置
allowAnonymous: false,  // 是否允许匿名访问
allowAnonymousEdits: true, // 是否允许匿名编辑
defaultPermission: 'editable', // 默认权限

// 数据库配置
dbURL: '',              // 数据库连接URL
db: {},                 // 数据库配置

// 会话配置
sessionName: 'connect.sid', // 会话名称
sessionSecret: 'secret',    // 会话密钥
sessionLife: 14 * 24 * 60 * 60 * 1000, // 会话生命周期

// 图片上传配置
imageUploadType: 'filesystem', // 图片上传类型
```

### 认证配置

```javascript
// OAuth配置
github: {
  clientID: undefined,
  clientSecret: undefined
},
gitlab: {
  baseURL: undefined,
  clientID: undefined,
  clientSecret: undefined
},

// LDAP配置
ldap: {
  url: undefined,
  bindDn: undefined,
  bindCredentials: undefined,
  searchBase: undefined,
  searchFilter: undefined,
  // ...
},

// SAML配置
saml: {
  idpSsoUrl: undefined,
  idpCert: undefined,
  // ...
}
```

## 开发环境搭建

### 前置要求

- Node.js (>=14.0.0 <17.0.0)
- npm
- Git
- 数据库（PostgreSQL/MySQL/SQLite）

### 安装步骤

1. 克隆仓库
   ```bash
   git clone https://github.com/xxx/editor.git
   cd editor
   ```

2. 安装依赖
   ```bash
   npm install
   ```

3. 配置环境
   ```bash
   cp config.json.example config.json
   # 编辑config.json配置数据库连接等
   ```

4. 启动开发服务器
   ```bash
   npm run dev
   ```

5. 构建生产版本
   ```bash
   npm run build
   ```

### Docker开发环境(待实现)

也可以使用Docker快速设置开发环境：

```bash
# 使用docker-compose启动开发环境
docker-compose up
```

